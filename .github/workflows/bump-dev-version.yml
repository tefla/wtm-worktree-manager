name: Bump Dev Version

on:
  push:
    branches:
      - development

permissions:
  contents: write

jobs:
  version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install cargo-edit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-edit

      - name: Compute next dev version
        id: compute
        run: |
          set -euo pipefail
          current="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "wtm") | .version')"
          new_version="$(CURRENT_VERSION="$current" python3 <<'PY'
import os
current = os.environ["CURRENT_VERSION"]
base = current.split("-dev")[0]
parts = base.split(".")
if len(parts) != 3:
    raise SystemExit(f"Unexpected version format: {current}")
major, minor, patch = map(int, parts)
patch += 1
new_version = f"{major}.{minor}.{patch}-dev"
print(new_version, end="")
PY
)"
          if [ "$new_version" = "$current" ]; then
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "current_version=$current" >> "$GITHUB_OUTPUT"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "updated=true" >> "$GITHUB_OUTPUT"

      - name: Update Cargo.toml
        if: steps.compute.outputs.updated == 'true'
        run: cargo set-version "${{ steps.compute.outputs.new_version }}" --manifest-path Cargo.toml

      - name: Commit changes
        if: steps.compute.outputs.updated == 'true'
        run: |
          git config user.name "wtm-release-bot"
          git config user.email "releases@wtm"
          git add Cargo.toml Cargo.lock
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: bump dev version to ${{ steps.compute.outputs.new_version }}"

      - name: Push commit
        if: steps.compute.outputs.updated == 'true'
        run: git push origin HEAD
